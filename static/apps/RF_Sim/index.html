<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Team Drone Site Assessment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .container { max-width: 1024px; }
        table th, table td { padding: 0.75rem 1rem; }
        .checklist-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; }
        .checklist-item:last-child { border-bottom: none; }
        /* Mobile optimizations */
        @media (max-width: 768px) {
            h1 { font-size: 1.5rem !important; }
            h2 { font-size: 1.125rem !important; }
            .p-6 { padding: 1rem !important; }
            .p-8 { padding: 1rem !important; }
            table th, table td {
                padding: 0.5rem;
                font-size: 0.75rem;
            }
            .checklist-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
                padding: 1rem 0.75rem;
            }
            .checklist-item .flex.gap-4 {
                width: 100%;
                justify-content: flex-start;
            }
            input[type="number"] {
                font-size: 16px !important;
                min-height: 44px;
                width: 100% !important;
            }
            input[type="radio"] {
                width: 20px;
                height: 20px;
            }
            label {
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            button[type="submit"], button[type="button"] {
                min-height: 52px;
                font-size: 1rem;
            }
            .overflow-x-auto { -webkit-overflow-scrolling: touch; }
        }
        @media (max-width: 480px) {
            h1 { font-size: 1.25rem !important; }
            .grid.md\\:grid-cols-2 { grid-template-columns: 1fr; }
            .checklist-item input[type="number"] {
                width: 48% !important;
            }
            .flex.justify-end { flex-direction: column; gap: 0.5rem; }
            .flex.justify-end button { width: 100%; margin: 0 !important; }
        }
        /* Touch-friendly */
        button, input, label {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4">

    <div class="container mx-auto bg-white rounded-lg shadow-xl p-8 space-y-8">
        <h1 class="text-3xl font-bold text-center text-gray-900">Red Team Site Assessment Simulator</h1>
        
        <div class="text-sm text-gray-600 text-right">
            Operator ID: <span id="user-id-display" class="font-mono font-semibold text-gray-800">Authenticating...</span>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-md p-6 shadow-sm">
            <h2 class="text-xl font-semibold text-blue-800 mb-3">Mission Briefing</h2>
            <p class="text-gray-700 leading-relaxed space-y-1">
                <span><strong>Operation:</strong> <span id="scenario-mission" class="font-medium">Loading...</span></span><br>
                <span><strong>Target Area:</strong> <span id="scenario-ao-name" class="font-medium">Loading...</span></span><br>
                <span><strong>Date / Time:</strong> <span id="scenario-date" class="font-medium">Loading...</span></span><br>
                <span><strong>Intel Requirement:</strong> <span id="scenario-pir-sir" class="font-medium">Loading...</span></span><br>
                <span><strong>Asset:</strong> <span id="air-team-drone" class="font-medium">Loading...</span></span><br>
                <span><strong>C2 Link Budget at Target:</strong> <span id="c2-link-budget" class="font-medium">Loading...</span></span><br>
                <span class="block mt-2"><strong>Visual Recon of Launch Site:</strong> <span id="visual-site-assessment" class="font-medium">Loading...</span></span>
            </p>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-gray-50 border border-gray-200 rounded p-4">
                <h3 class="font-semibold text-gray-800">Obstacle Clearance Guidelines</h3>
                <ul class="list-disc list-inside text-sm text-gray-600 mt-2 space-y-1">
                    <li>Establish a <strong>30 ft safety bubble</strong> (frangible zone) around the launch/land point.</li>
                    <li>Maintain at least <strong>50 ft horizontal</strong> clearance from all obstacles.</li>
                    <li>Cell towers and power lines are critical RF and physical hazards; maximize standoff distance.</li>
                </ul>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded p-4">
                <h3 class="font-semibold text-gray-800">RF Safety Margin Rule</h3>
                 <p class="text-sm text-gray-600 mt-2">The Air Team's C2 link must be **15-20 dB stronger** than any co-channel interference to be reliable.</p>
                 <p class="font-mono text-sm bg-gray-200 p-2 mt-2 rounded">`Margin = (C2 Budget) - (Interference)`</p>
            </div>
        </div>

        <div class="bg-gray-50 border border-gray-200 rounded-md p-6 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">RF Scan Data</h2>
            <div class="mb-4">
                <span class="font-semibold text-gray-700">Average Noise Floor:</span>
                <span id="noise-floor-display" class="font-mono font-bold text-lg ml-2 text-indigo-600">Loading...</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-md overflow-hidden">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Frequency (MHz)</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Signal Strength (dBm)</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Description</th>
                        </tr>
                    </thead>
                    <tbody id="rf-scan-data-body" class="divide-y divide-gray-200">
                         <tr><td colspan="3" class="text-center py-4 text-gray-500">Scanning for signals...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white border border-gray-200 rounded-md p-6 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Go/No-Go Checklist</h2>
            <form id="field-report-form" class="space-y-4">
                <div class="checklist-item">
                     <label class="font-medium text-gray-700">1. Identify the single most critical interfering signal:</label>
                     <div class="flex gap-4">
                        <input type="number" id="report-freq" class="w-32 px-2 py-1 border border-gray-300 rounded" placeholder="Freq (MHz)" required>
                        <input type="number" id="report-strength" class="w-32 px-2 py-1 border border-gray-300 rounded" placeholder="Strength (dBm)" required>
                     </div>
                </div>
                <div class="checklist-item">
                    <label class="font-medium text-gray-700">2. Does the Air Team have a C2 safety margin > 15 dB?</label>
                    <div class="flex gap-4">
                        <label><input type="radio" name="margin-check" value="yes" required> Yes</label>
                        <label><input type="radio" name="margin-check" value="no"> No</label>
                    </div>
                </div>
                 <div class="checklist-item">
                    <label class="font-medium text-gray-700">3. Are any mission-critical signals (e.g., GPS) being jammed?</label>
                    <div class="flex gap-4">
                        <label><input type="radio" name="jammer-check" value="yes" required> Yes</label>
                        <label><input type="radio" name="jammer-check" value="no"> No</label>
                    </div>
                </div>
                <div class="checklist-item">
                    <label class="font-medium text-gray-700">4. Is the launch zone clear of physical hazards?</label>
                    <div class="flex gap-4">
                        <label><input type="radio" name="physical-check" value="yes" required> Yes</label>
                        <label><input type="radio" name="physical-check" value="no"> No</label>
                    </div>
                </div>
                <div class="checklist-item bg-indigo-50 p-4 rounded-md">
                    <label class="font-semibold text-indigo-800 text-lg">5. Final GO / NO-GO Recommendation for Air Team:</label>
                    <div class="flex gap-4">
                        <label class="flex items-center"><input type="radio" name="nest-site-suitability" value="Green" class="form-radio text-green-600 h-5 w-5" required><span class="ml-2 text-green-700 font-bold">GO</span></label>
                        <label class="flex items-center"><input type="radio" name="nest-site-suitability" value="Red" class="form-radio text-red-600 h-5 w-5"><span class="ml-2 text-red-700 font-bold">NO-GO</span></label>
                    </div>
                </div>
                <div class="flex justify-end items-center pt-4">
                    <button type="button" id="generate-new-scan-btn" class="px-6 py-2 mr-4 bg-gray-600 text-white rounded-md shadow-md hover:bg-gray-700">New Scenario</button>
                    <button type="submit" id="submit-report-btn" class="px-8 py-3 bg-indigo-600 text-white rounded-md shadow-md hover:bg-indigo-700 text-base font-medium">Submit Checklist</button>
                </div>
            </form>
        </div>

        <div id="feedback-area" class="bg-yellow-50 border border-yellow-200 rounded-md p-6 shadow-sm hidden">
            <h2 class="text-xl font-semibold text-yellow-800 mb-3">Assessment Debrief</h2>
            <div id="assessment-results" class="text-gray-700 space-y-2"></div>
            <div id="correct-answer-hint" class="text-sm text-gray-600 mt-4 hidden">
                <h3 class="font-semibold text-yellow-800">Instructor's Assessment:</h3>
                <p id="expected-rf-summary" class="leading-relaxed"></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- IMPORTANT: PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBgGcRPxEy47tAAybaOgqp2NFNCmXq8U2s",
            authDomain: "ulfc-mss.firebaseapp.com",
            projectId: "ulfc-mss",
            storageBucket: "ulfc-mss.firebasestorage.app",
            messagingSenderId: "925555368763",
            appId: "1:925555368763:web:cc6ea1cba8966a58988d1e",
            measurementId: "G-NQ9WXTL28W"
        };
        // --- END OF FIREBASE CONFIG SECTION ---
        
        // --- Global State ---
        let currentScenario = {};
        let db, auth, userId;
        const appId = firebaseConfig.projectId;

        // --- DOM Elements ---
        const userIdDisplay = document.getElementById('user-id-display');
        const scenarioMission = document.getElementById('scenario-mission');
        const scenarioAoName = document.getElementById('scenario-ao-name');
        const scenarioDate = document.getElementById('scenario-date');
        const scenarioPirSir = document.getElementById('scenario-pir-sir');
        const airTeamDroneDisplay = document.getElementById('air-team-drone');
        const c2LinkBudgetDisplay = document.getElementById('c2-link-budget');
        const visualSiteAssessmentDisplay = document.getElementById('visual-site-assessment');
        const noiseFloorDisplay = document.getElementById('noise-floor-display');
        const rfScanDataBody = document.getElementById('rf-scan-data-body');
        const fieldReportForm = document.getElementById('field-report-form');
        const reportFreqInput = document.getElementById('report-freq');
        const reportStrengthInput = document.getElementById('report-strength');
        const generateNewScanBtn = document.getElementById('generate-new-scan-btn');
        const feedbackArea = document.getElementById('feedback-area');
        const assessmentResults = document.getElementById('assessment-results');
        const correctAnswerHint = document.getElementById('correct-answer-hint');
        const expectedRfSummary = document.getElementById('expected-rf-summary');

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                    } else {
                        userId = 'anonymous-' + crypto.randomUUID();
                        userIdDisplay.textContent = `Anonymous`;
                    }
                    generateScenario();
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                userIdDisplay.textContent = 'Auth Error';
                generateScenario();
            }
        }

        // --- Firestore Save Function ---
        async function saveReportToFirestore(reportData) {
            if (!db || !userId) { 
                console.log("Firestore not ready, skipping save.");
                return; 
            }
            try {
                const reportsCollectionRef = collection(db, `red_team_assessments/${appId}/operators/${userId}/reports`);
                await addDoc(reportsCollectionRef, { ...reportData, timestamp: serverTimestamp() });
            } catch (error) {
                console.error("Error saving report to Firestore:", error);
            }
        }

        // --- Scenarios ---
        const scenarios = [
            {
                aoName: "Georgia State Capitol, Atlanta, GA",
                mission: "Urban mapping mission to gather imagery of government buildings.",
                pirSir: "Assess 2.4 GHz band for C2 viability.",
                airTeamDrone: "DJI Mavic 2 Pro",
                c2LinkBudget: -70,
                noiseFloor: -90,
                visualAssessment: "Launch from a parking garage rooftop. Heavy pedestrian/vehicle traffic below. Multiple visible antennas on rooftops.",
                isJammerPresent: false,
                isPhysicallySafe: false,
                rfData: [ 
                    { freq: 2412, strength: -88, desc: "Business Wi-Fi" },
                    { freq: 2420, strength: -91, desc: "Bluetooth Headset" },
                    { freq: 2437, strength: -65, desc: "Public Wi-Fi Hotspot" }, // This is the critical one
                    { freq: 2450, strength: -95, desc: "Unknown digital signal" },
                    { freq: 2462, strength: -89, desc: "Business Wi-Fi" },
                ],
                expectedNestSiteSuitability: "Red",
                expectedRfSummary: "<strong>RF Assessment: RED.</strong> Your C2 budget of -70 dBm against a -65 dBm Wi-Fi hotspot leaves only a 5 dB margin. This is an unacceptable risk for an urban flight. <br><strong>Physical Assessment: RED.</strong> The proposed launch site is unsafe due to heavy traffic and lack of a clear safety zone. <br><strong>Final Recommendation: NO-GO.</strong>"
            },
            {
                aoName: "Fort Moore (Benning) Main Gate, Columbus, GA",
                mission: "Autonomous payload delivery to a drop point 2km from the base perimeter.",
                pirSir: "Detect any GPS interference that would compromise autonomous flight.",
                airTeamDrone: "Autel Evo II",
                c2LinkBudget: -75,
                noiseFloor: -105,
                visualAssessment: "Launch from a wooded area just outside the base perimeter. The area is remote and clear of most obstacles.",
                isJammerPresent: true,
                isPhysicallySafe: true,
                rfData: [ 
                    { freq: 462.56, strength: -75, desc: "FRS Radio (Security)" },
                    { freq: 855.20, strength: -80, desc: "Cellular Tower" },
                    { freq: 1220.60, strength: -90, desc: "GPS L2 band noise" },
                    { freq: 1575.42, strength: -70, desc: "GPS Jammer (Military Training)" }, // This is the critical one
                    { freq: 2412.00, strength: -95, desc: "Distant Wi-Fi" },
                ],
                expectedNestSiteSuitability: "Red",
                expectedRfSummary: "<strong>RF Assessment: RED.</strong> The powerful signal on the GPS L1 frequency (-70 dBm) indicates active jamming. This guarantees failure for any autonomous mission, regardless of C2 link strength. <br><strong>Physical Assessment: GREEN.</strong> The site itself is physically safe. <br><strong>Final Recommendation: NO-GO.</strong> Mission is impossible due to GPS denial."
            },
            {
                aoName: "Atlantic Station, Atlanta, GA",
                mission: "Autonomous payload delivery to a rooftop in a dense commercial area, using a 900 MHz C2 link.",
                pirSir: "Confirm viability of the 900 MHz C2 link.",
                airTeamDrone: "Custom ArduCopter Quad",
                c2LinkBudget: -90,
                noiseFloor: -99,
                visualAssessment: "Launch from a concealed alleyway. Flight path crosses multiple buildings and roads.",
                isJammerPresent: false,
                isPhysicallySafe: false,
                rfData: [
                    { freq: 905.5, strength: -92, desc: "IoT Sensor Network" },
                    { freq: 915.0, strength: -85, desc: "Building Automation System" }, // This is the critical one
                    { freq: 920.1, strength: -95, desc: "Unknown Hopping Signal" },
                    { freq: 925.8, strength: -91, desc: "RFID Reader" }
                ],
                expectedNestSiteSuitability: "Red",
                expectedRfSummary: "<strong>RF Assessment: RED.</strong> The C2 link budget of -90 dBm provides only a 5 dB safety margin over the -85 dBm interference from the building's automation system. This is critically low for a BVLOS autonomous mission. <br><strong>Physical Assessment: RED.</strong> The flight path and launch site are unacceptably hazardous. <br><strong>Final Recommendation: NO-GO.</strong>"
            },
            {
                aoName: "Riverwalk, Columbus, GA",
                mission: "Urban mapping mission of the riverfront park area.",
                pirSir: "Characterize the 5.8 GHz band to determine if a clean, high-bandwidth video feed is possible.",
                airTeamDrone: "DJI Mavic 3 Pro",
                c2LinkBudget: -72,
                noiseFloor: -95,
                visualAssessment: "Launch from a designated park area. Target area includes pedestrian bridges and open parkland.",
                isJammerPresent: false,
                isPhysicallySafe: true,
                rfData: [
                    { freq: 5745, strength: -94, desc: "Distant Wi-Fi" },
                    { freq: 5785, strength: -91, desc: "Municipal Wi-Fi" }, // This is the strongest, but still very weak.
                    { freq: 5805, strength: -95, desc: "Security Camera" },
                    { freq: 5825, strength: -92, desc: "Wi-Fi" },
                ],
                expectedNestSiteSuitability: "Green",
                expectedRfSummary: "<strong>RF Assessment: GREEN.</strong> The C2 budget of -72 dBm provides a 21 dB safety margin over the strongest interferer (-91 dBm). The 5.8 GHz band is exceptionally clean and ideal for a high-quality video link. <br><strong>Physical Assessment: GREEN.</strong> The park is a suitable and safe launch area. <br><strong>Final Recommendation: GO.</strong> The site is highly suitable for the air team's operation."
            }
        ];
        
        function generateScenario() {
            fieldReportForm.reset();
            feedbackArea.classList.add('hidden');
            currentScenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            
            scenarioMission.textContent = currentScenario.mission;
            scenarioAoName.textContent = currentScenario.aoName;
            scenarioDate.textContent = new Date().toLocaleDateString('en-US', { timeZone: "America/New_York", year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            scenarioPirSir.textContent = currentScenario.pirSir;
            airTeamDroneDisplay.textContent = currentScenario.airTeamDrone;
            c2LinkBudgetDisplay.textContent = `${currentScenario.c2LinkBudget} dBm`;
            visualSiteAssessmentDisplay.textContent = currentScenario.visualAssessment;
            noiseFloorDisplay.textContent = `${currentScenario.noiseFloor} dBm`;

            rfScanDataBody.innerHTML = '';
            currentScenario.rfData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-mono">${item.freq.toFixed(2)}</td>
                    <td class="font-mono">${item.strength}</td>
                    <td>${item.desc}</td>
                `;
                rfScanDataBody.appendChild(row);
            });
        }

        function assessReport(userData) {
            const feedback = [];
            const { freq, strength, marginCheck, jammerCheck, physicalCheck, finalRec } = userData;
            
            const strongestSignal = currentScenario.rfData.length > 0 ? currentScenario.rfData.reduce((p, c) => p.strength > c.strength ? p : c) : { freq: 0, strength: -999 };
            if (Math.abs(freq - strongestSignal.freq) < 10 && Math.abs(strength - strongestSignal.strength) < 5) {
                feedback.push(`<p class="text-green-600">✅ **Signal ID:** Correctly identified the most critical signal.</p>`);
            } else {
                 feedback.push(`<p class="text-red-600">❌ **Signal ID:** Incorrect. The most critical signal was ~${strongestSignal.strength} dBm at ${strongestSignal.freq} MHz.</p>`);
            }
            
            const correctMargin = (currentScenario.c2LinkBudget - strongestSignal.strength) > 15 ? 'yes' : 'no';
            if (marginCheck === correctMargin) feedback.push(`<p class="text-green-600">✅ **Safety Margin:** Correctly assessed.</p>`);
            else feedback.push(`<p class="text-red-600">❌ **Safety Margin:** Incorrect. The correct answer was ${correctMargin.toUpperCase()}.</p>`);

            const correctJammer = currentScenario.isJammerPresent ? 'yes' : 'no';
            if (jammerCheck === correctJammer) feedback.push(`<p class="text-green-600">✅ **Jammer Detection:** Correct.</p>`);
            else feedback.push(`<p class="text-red-600">❌ **Jammer Detection:** Incorrect. You missed the status of mission-critical interference.</p>`);

            const correctPhysical = currentScenario.isPhysicallySafe ? 'yes' : 'no';
            if (physicalCheck === correctPhysical) feedback.push(`<p class="text-green-600">✅ **Physical Hazards:** Correctly assessed.</p>`);
            else feedback.push(`<p class="text-red-600">❌ **Physical Hazards:** Incorrect. The site was physically ${correctPhysical === 'yes' ? 'safe' : 'unsafe'}.</p>`);

            if(finalRec === currentScenario.expectedNestSiteSuitability) feedback.push(`<p class="text-green-600">✅ **Final Recommendation:** Correct GO/NO-GO decision.</p>`);
            else feedback.push(`<p class="text-red-600">❌ **Final Recommendation:** Incorrect. The correct call was ${currentScenario.expectedNestSiteSuitability === 'Green' ? 'GO' : 'NO-GO'}.</p>`);
            
            return { feedback, expectedSummary: currentScenario.expectedRfSummary };
        }

        // --- Event Listeners ---
        generateNewScanBtn.addEventListener('click', generateScenario);
        fieldReportForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const userData = {
                freq: parseFloat(reportFreqInput.value) || 0,
                strength: parseFloat(reportStrengthInput.value) || -110,
                marginCheck: document.querySelector('input[name="margin-check"]:checked')?.value,
                jammerCheck: document.querySelector('input[name="jammer-check"]:checked')?.value,
                physicalCheck: document.querySelector('input[name="physical-check"]:checked')?.value,
                finalRec: document.querySelector('input[name="nest-site-suitability"]:checked')?.value
            };
            if (!userData.marginCheck || !userData.jammerCheck || !userData.physicalCheck || !userData.finalRec) return;

            assessmentResults.innerHTML = '';
            const assessment = assessReport(userData);
            assessment.feedback.forEach(line => assessmentResults.innerHTML += line);
            
            if (userData.finalRec !== currentScenario.expectedNestSiteSuitability) {
                correctAnswerHint.classList.remove('hidden');
                expectedRfSummary.innerHTML = assessment.expectedSummary;
            } else {
                correctAnswerHint.classList.add('hidden');
            }

            feedbackArea.classList.remove('hidden');
            feedbackArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

            await saveReportToFirestore({ scenario: currentScenario.aoName, userChecklist: userData, assessment: assessment.feedback });
        });
        
        initializeFirebase();
    </script>
</body>
</html>